
首先考虑一般情况，当所有的$a_i=0$，显然结果为$\Pi deg(u)!$，那么本题核心在于最后每个点的形态与每个点连出的边的相对操作顺序强相关，所以对每个点计算出其连出的所有边的相对操作顺序共有多少合法情况，将每个点的合法情况数乘起来即为最后的总方案数。

那么如何计算每个点连出的所有边的相对操作顺序共有多少合法情况？当所有$a_i=0$时，显然没有限制，直接阶乘，那么考虑$a_i$对边操作相对顺序带来的影响，对每个$a_i != 0$可得到一条树上路径$u \rightarrow v$，表示旅游指数`u`应从原始节点`u`移动至目标节点`v`（也就是当前的`i`），由于每条边仅操作一次，故该移动必须沿着树上`u`到`v`的最短路径移动，不可能重复经过某条边。考虑该路径为$u,x_1,x_2,...,x_k,v$，那么边$u \rightarrow x_1$必须为从$u$出发的第一个被操作的边，边$x_k \rightarrow v$必须为连接$v$的最后一个操作的边，中间情况下，例如对点$x_1$来说，边 $u \rightarrow x_1$ 操作完后必须继续操作 $x_1 \rightarrow x_2$。得到最终的可以自由操作的情况后，每个点的结果依然是个阶乘。注意需要判断许多错误情况：对点$u$来说，是否存在两条边都必须第一个被操作，是否存在两条边都必须被最后一个操作，边之间的操作顺序是否形成了一个环，是否存在第一条边的严格下一条边是最后一条边，但点$u$仍然存在其他边的情况。如果错误检查都没问题之后，计算点$u$受到几个限制，考虑自由情况的阶乘即是点$u$的结果，最终全部点乘起来即为所有的结果。